"use strict";(()=>{var e={};e.id=372,e.ids=[372],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},26839:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>y,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>R,serverHooks:()=>S,staticGenerationAsyncStorage:()=>T});var t={};s.r(t),s.d(t,{DELETE:()=>d,GET:()=>l,PATCH:()=>E});var i=s(49303),a=s(88716),n=s(60670),o=s(87070),c=s(45609),p=s(67024),u=s(69234),_=s(42729);async function l(e){try{let e=await (0,c.getServerSession)(p.a);if(!e?.user?.email)return o.NextResponse.json({error:"Authentication required"},{status:401});let r=(0,_.N)(),s=r.prepare("SELECT id, tier FROM users WHERE email = ?").get(e.user.email);if(!s)return o.NextResponse.json({error:"User not found"},{status:404});let t=r.prepare(`
      SELECT 
        s.*,
        st.name as tier_name,
        st.price_monthly,
        st.price_yearly,
        st.features,
        st.ai_interactions_daily as ai_interactions_per_day,
        st.map_access_level
      FROM user_subscriptions s
      JOIN subscription_tiers st ON s.tier_id = st.id
      WHERE s.user_id = ? AND s.status = 'active'
      ORDER BY s.created_at DESC
      LIMIT 1
    `).get(s.id);if(!t){let e=s.tier||"free",t=r.prepare("SELECT * FROM subscription_tiers WHERE id = ?").get(e);return o.NextResponse.json({tier:e,status:"active",features:t?JSON.parse(t.features):["account_dashboard"],aiInteractionsPerDay:t?.ai_interactions_daily||3,mapAccessLevel:t?.map_access_level||"basic",isActive:!0})}let i="active"===t.status&&new Date(t.current_period_end)>new Date;return o.NextResponse.json({id:t.id,tier:t.tier_name,status:t.status,stripeSubscriptionId:t.stripe_subscription_id,currentPeriodStart:t.current_period_start,currentPeriodEnd:t.current_period_end,cancelAtPeriodEnd:t.cancel_at_period_end,features:JSON.parse(t.features),aiInteractionsPerDay:t.ai_interactions_per_day,mapAccessLevel:t.map_access_level,priceMonthly:t.price_monthly,priceYearly:t.price_yearly,isActive:i})}catch(e){return console.error("Error fetching subscription:",e),o.NextResponse.json({error:"Failed to fetch subscription"},{status:500})}}async function d(e){try{let e=await (0,c.getServerSession)(p.a);if(!e?.user?.email)return o.NextResponse.json({error:"Authentication required"},{status:401});let r=(0,_.N)(),s=r.prepare("SELECT id FROM users WHERE email = ?").get(e.user.email);if(!s)return o.NextResponse.json({error:"User not found"},{status:404});let t=r.prepare(`
      SELECT stripe_subscription_id 
      FROM user_subscriptions 
      WHERE user_id = ? AND status = 'active'
      ORDER BY created_at DESC
      LIMIT 1
    `).get(s.id);if(!t?.stripe_subscription_id)return o.NextResponse.json({error:"No active subscription found"},{status:404});if(!u.A)return o.NextResponse.json({error:"Payment processing not configured"},{status:503});return await u.A.subscriptions.update(t.stripe_subscription_id,{cancel_at_period_end:!0}),r.prepare(`
      UPDATE user_subscriptions 
      SET cancel_at_period_end = 1, updated_at = CURRENT_TIMESTAMP
      WHERE stripe_subscription_id = ?
    `).run(t.stripe_subscription_id),o.NextResponse.json({message:"Subscription will be canceled at the end of the current period"})}catch(e){return console.error("Error canceling subscription:",e),o.NextResponse.json({error:"Failed to cancel subscription"},{status:500})}}async function E(e){try{let r=await (0,c.getServerSession)(p.a);if(!r?.user?.email)return o.NextResponse.json({error:"Authentication required"},{status:401});let{action:s}=await e.json();if("reactivate"!==s)return o.NextResponse.json({error:"Invalid action"},{status:400});let t=(0,_.N)(),i=t.prepare("SELECT id FROM users WHERE email = ?").get(r.user.email);if(!i)return o.NextResponse.json({error:"User not found"},{status:404});let a=t.prepare(`
      SELECT stripe_subscription_id 
      FROM user_subscriptions 
      WHERE user_id = ? AND status = 'active' AND cancel_at_period_end = 1
      ORDER BY created_at DESC
      LIMIT 1
    `).get(i.id);if(!a?.stripe_subscription_id)return o.NextResponse.json({error:"No subscription found that can be reactivated"},{status:404});if(!u.A)return o.NextResponse.json({error:"Payment processing not configured"},{status:503});return await u.A.subscriptions.update(a.stripe_subscription_id,{cancel_at_period_end:!1}),t.prepare(`
      UPDATE user_subscriptions 
      SET cancel_at_period_end = 0, updated_at = CURRENT_TIMESTAMP
      WHERE stripe_subscription_id = ?
    `).run(a.stripe_subscription_id),o.NextResponse.json({message:"Subscription reactivated successfully"})}catch(e){return console.error("Error reactivating subscription:",e),o.NextResponse.json({error:"Failed to reactivate subscription"},{status:500})}}let R=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/subscriptions/route",pathname:"/api/subscriptions",filename:"route",bundlePath:"app/api/subscriptions/route"},resolvedPagePath:"E:\\Download\\savethemnow.Jesus\\src\\app\\api\\subscriptions\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:m,staticGenerationAsyncStorage:T,serverHooks:S}=R,y="/api/subscriptions/route";function v(){return(0,n.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:T})}},67024:(e,r,s)=>{s.d(r,{a:()=>o});var t=s(53797),i=s(77234),a=s(42729),n=s(98691);let o={providers:[(0,t.Z)({id:"credentials",name:"Email and Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=(0,a.N)(),s=r.prepare("SELECT id, email, password_hash, name, tier, email_verified FROM users WHERE email = ?").get(e.email);return s&&s.password_hash&&await n.ZP.compare(e.password,s.password_hash)?(r.prepare("UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?").run(s.id),{id:s.id.toString(),email:s.email,name:s.name,tier:s.tier,emailVerified:s.email_verified}):null}}),...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,i.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[]],session:{strategy:"jwt",maxAge:2592e3,updateAge:86400},callbacks:{session:async({session:e,token:r})=>(e?.user&&r&&(e.user.id=r.sub,e.user.tier=r.tier),e),jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.tier=r.tier),e)},pages:{signIn:"/auth/signin",signUp:"/auth/signup",error:"/auth/error",verifyRequest:"/auth/verify-request"}}},42729:(e,r,s)=>{s.d(r,{N:()=>l});let t=require("better-sqlite3");var i=s.n(t),a=s(92048),n=s.n(a),o=s(55315),c=s.n(o);let p=process.env.DATABASE_PATH||c().join(process.cwd(),"database.sqlite"),u=c().join(process.cwd(),"src/lib/database/schema.sql"),_=null;function l(){if(!_){let e=c().dirname(p);n().existsSync(e)||n().mkdirSync(e,{recursive:!0}),(_=new(i())(p)).pragma("journal_mode = WAL"),_.pragma("foreign_keys = ON"),_&&(_.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='users'").get()||(console.log("Initializing database schema..."),n().existsSync(u)?(n().readFileSync(u,"utf8").split(";").filter(e=>e.trim()).forEach(e=>{try{_.exec(e)}catch(e){console.error("Error executing schema statement:",e)}}),console.log("Database schema initialized successfully")):console.error("Schema file not found at:",u)))}return _}function d(){_&&(_.close(),_=null)}process.on("SIGINT",d),process.on("SIGTERM",d)},69234:(e,r,s)=>{s.d(r,{A:()=>i,K:()=>a});var t=s(31059);let i=process.env.STRIPE_SECRET_KEY?new t.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-11-20.acacia",typescript:!0}):null,a={publishableKey:process.env.STRIPE_PUBLISHABLE_KEY||"",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET||"",currency:"usd",prices:{supporter_monthly:process.env.STRIPE_SUPPORTER_MONTHLY_PRICE_ID||"",supporter_yearly:process.env.STRIPE_SUPPORTER_YEARLY_PRICE_ID||"",advocate_monthly:process.env.STRIPE_ADVOCATE_MONTHLY_PRICE_ID||"",advocate_yearly:process.env.STRIPE_ADVOCATE_YEARLY_PRICE_ID||"",guardian_monthly:process.env.STRIPE_GUARDIAN_MONTHLY_PRICE_ID||"",guardian_yearly:process.env.STRIPE_GUARDIAN_YEARLY_PRICE_ID||"",hero_monthly:process.env.STRIPE_HERO_MONTHLY_PRICE_ID||"",hero_yearly:process.env.STRIPE_HERO_YEARLY_PRICE_ID||""}}}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,972,691,830,59],()=>s(26839));module.exports=t})();