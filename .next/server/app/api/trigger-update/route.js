"use strict";(()=>{var e={};e.id=303,e.ids=[303],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},20629:e=>{e.exports=require("fs/promises")},55315:e=>{e.exports=require("path")},27151:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>y});var i={};r.r(i),r.d(i,{GET:()=>l,POST:()=>d});var s=r(49303),o=r(88716),n=r(60670),a=r(87070),u=r(61282),c=r(55315),p=r.n(c);async function d(e){try{let t,i;let s=await e.json(),o=["full","incremental","geocoding","urgent"],n=["low","medium","high","critical"];if(!o.includes(s.type))return a.NextResponse.json({error:"Invalid update type",valid_types:o},{status:400});if(!n.includes(s.priority))return a.NextResponse.json({error:"Invalid priority level",valid_priorities:n},{status:400});let c=new Date,d=p().join(process.cwd(),"missing-persons.csv"),l=s.reason||"Manual trigger";try{let e=await Promise.resolve().then(r.t.bind(r,20629,23)),t=await e.stat(d),i=(c.getTime()-t.mtime.getTime())/36e5;i>48?(l=`Data critically stale (${i.toFixed(1)} hours old)`,s.priority="critical"):i>24&&(l=`Data stale (${i.toFixed(1)} hours old)`,"low"===s.priority&&(s.priority="medium"))}catch(e){l="CSV file missing or inaccessible",s.priority="critical"}switch(s.type){case"full":t="python",i=["pipeline_cli.py","run"];break;case"incremental":t="python",i=["pipeline_cli.py","run","--incremental"];break;case"geocoding":t="python",i=["pipeline_cli.py","geocode","--limit","1000"];break;case"urgent":t="python",i=["pipeline_cli.py","run","--urgent-only"];break;default:return a.NextResponse.json({error:"Unknown update type"},{status:400})}let m={id:`trigger_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:s.type,priority:s.priority,reason:l,triggered_at:c.toISOString(),triggered_by:"api",status:"initiated"};if("critical"!==s.priority&&"high"!==s.priority)return m.status="queued",a.NextResponse.json({success:!0,trigger:m,message:`${s.type} update queued with ${s.priority} priority`,execution:"queued"});try{return(0,u.spawn)(t,i,{cwd:process.cwd(),detached:!0,stdio:"ignore"}).unref(),m.status="executing",a.NextResponse.json({success:!0,trigger:m,message:`${s.type} update triggered with ${s.priority} priority`,execution:"immediate"})}catch(e){return m.status="failed",a.NextResponse.json({success:!1,trigger:m,error:e instanceof Error?e.message:"Unknown error",execution:"failed"},{status:500})}}catch(e){return console.error("Error triggering update:",e),a.NextResponse.json({error:e instanceof Error?e.message:"Unknown error",success:!1},{status:500})}}async function l(){try{let e=new Date,t=p().join(process.cwd(),"missing-persons.csv");p().join(process.cwd(),"database","app.db");let i=null;try{let s=await Promise.resolve().then(r.t.bind(r,20629,23)),o=await s.stat(t),n=(e.getTime()-o.mtime.getTime())/36e5;n>72?i={type:"full",priority:"critical",reason:`Data extremely stale (${n.toFixed(1)} hours old)`,recommended_action:"immediate"}:n>48?i={type:"full",priority:"high",reason:`Data critically stale (${n.toFixed(1)} hours old)`,recommended_action:"immediate"}:n>24&&(i={type:"incremental",priority:"medium",reason:`Data stale (${n.toFixed(1)} hours old)`,recommended_action:"queue"})}catch(e){i={type:"full",priority:"critical",reason:"CSV file missing or inaccessible",recommended_action:"immediate"}}return a.NextResponse.json({timestamp:e.toISOString(),auto_trigger_recommendation:i,available_triggers:[{type:"full",description:"Complete data collection from all sources",estimated_duration:"15-30 minutes",resource_intensive:!0},{type:"incremental",description:"Update only changed/new records",estimated_duration:"5-10 minutes",resource_intensive:!1},{type:"geocoding",description:"Process records missing coordinates",estimated_duration:"5-15 minutes",resource_intensive:!1},{type:"urgent",description:"Process only urgent missing children cases",estimated_duration:"2-5 minutes",resource_intensive:!1}],priority_levels:{critical:"Execute immediately, override running jobs",high:"Execute immediately",medium:"Queue for next available slot",low:"Queue for next scheduled run"}})}catch(e){return console.error("Error getting trigger status:",e),a.NextResponse.json({error:e instanceof Error?e.message:"Unknown error"},{status:500})}}let m=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/trigger-update/route",pathname:"/api/trigger-update",filename:"route",bundlePath:"app/api/trigger-update/route"},resolvedPagePath:"E:\\Download\\savethemnow.Jesus\\src\\app\\api\\trigger-update\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:y,serverHooks:h}=m,x="/api/trigger-update/route";function w(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:y})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[276,972],()=>r(27151));module.exports=i})();