"use strict";(()=>{var e={};e.id=701,e.ids=[701],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},82284:(e,r,s)=>{s.r(r),s.d(r,{originalPathname:()=>I,patchFetch:()=>T,requestAsyncStorage:()=>E,routeModule:()=>_,serverHooks:()=>R,staticGenerationAsyncStorage:()=>m});var t={};s.r(t),s.d(t,{POST:()=>d});var i=s(49303),a=s(88716),o=s(60670),n=s(87070),p=s(45609),c=s(67024),u=s(69234),l=s(42729);async function d(e){try{let r;if(!u.A)return n.NextResponse.json({error:"Payment processing not configured"},{status:503});let s=await (0,p.getServerSession)(c.a);if(!s?.user?.email)return n.NextResponse.json({error:"Authentication required"},{status:401});let{priceId:t,successUrl:i,cancelUrl:a}=await e.json();if(!t)return n.NextResponse.json({error:"Price ID is required"},{status:400});let o=(0,l.N)().prepare("SELECT stripe_customer_id FROM subscriptions WHERE user_email = ? AND stripe_customer_id IS NOT NULL LIMIT 1").get(s.user.email);r=o?.stripe_customer_id?o.stripe_customer_id:(await u.A.customers.create({email:s.user.email,name:s.user.name||void 0,metadata:{userEmail:s.user.email}})).id;let d=await u.A.checkout.sessions.create({customer:r,payment_method_types:["card"],line_items:[{price:t,quantity:1}],mode:"subscription",success_url:i||`${process.env.SITE_URL}/profile?session_id={CHECKOUT_SESSION_ID}`,cancel_url:a||`${process.env.SITE_URL}/pricing`,metadata:{userEmail:s.user.email},subscription_data:{metadata:{userEmail:s.user.email}},allow_promotion_codes:!0});return n.NextResponse.json({sessionId:d.id,url:d.url})}catch(e){return console.error("Error creating subscription:",e),n.NextResponse.json({error:"Failed to create subscription"},{status:500})}}let _=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/create-subscription/route",pathname:"/api/stripe/create-subscription",filename:"route",bundlePath:"app/api/stripe/create-subscription/route"},resolvedPagePath:"E:\\Download\\savethemnow.Jesus\\src\\app\\api\\stripe\\create-subscription\\route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:E,staticGenerationAsyncStorage:m,serverHooks:R}=_,I="/api/stripe/create-subscription/route";function T(){return(0,o.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:m})}},67024:(e,r,s)=>{s.d(r,{a:()=>n});var t=s(53797),i=s(77234),a=s(42729),o=s(98691);let n={providers:[(0,t.Z)({id:"credentials",name:"Email and Password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=(0,a.N)(),s=r.prepare("SELECT id, email, password_hash, name, tier, email_verified FROM users WHERE email = ?").get(e.email);return s&&s.password_hash&&await o.ZP.compare(e.password,s.password_hash)?(r.prepare("UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?").run(s.id),{id:s.id.toString(),email:s.email,name:s.name,tier:s.tier,emailVerified:s.email_verified}):null}}),...process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET?[(0,i.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET})]:[]],session:{strategy:"jwt",maxAge:2592e3,updateAge:86400},callbacks:{session:async({session:e,token:r})=>(e?.user&&r&&(e.user.id=r.sub,e.user.tier=r.tier),e),jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.tier=r.tier),e)},pages:{signIn:"/auth/signin",signUp:"/auth/signup",error:"/auth/error",verifyRequest:"/auth/verify-request"}}},42729:(e,r,s)=>{s.d(r,{N:()=>d});let t=require("better-sqlite3");var i=s.n(t),a=s(92048),o=s.n(a),n=s(55315),p=s.n(n);let c=process.env.DATABASE_PATH||p().join(process.cwd(),"database.sqlite"),u=p().join(process.cwd(),"src/lib/database/schema.sql"),l=null;function d(){if(!l){let e=p().dirname(c);o().existsSync(e)||o().mkdirSync(e,{recursive:!0}),(l=new(i())(c)).pragma("journal_mode = WAL"),l.pragma("foreign_keys = ON"),l&&(l.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='users'").get()||(console.log("Initializing database schema..."),o().existsSync(u)?(o().readFileSync(u,"utf8").split(";").filter(e=>e.trim()).forEach(e=>{try{l.exec(e)}catch(e){console.error("Error executing schema statement:",e)}}),console.log("Database schema initialized successfully")):console.error("Schema file not found at:",u)))}return l}function _(){l&&(l.close(),l=null)}process.on("SIGINT",_),process.on("SIGTERM",_)},69234:(e,r,s)=>{s.d(r,{A:()=>i,K:()=>a});var t=s(31059);let i=process.env.STRIPE_SECRET_KEY?new t.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-11-20.acacia",typescript:!0}):null,a={publishableKey:process.env.STRIPE_PUBLISHABLE_KEY||"",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET||"",currency:"usd",prices:{supporter_monthly:process.env.STRIPE_SUPPORTER_MONTHLY_PRICE_ID||"",supporter_yearly:process.env.STRIPE_SUPPORTER_YEARLY_PRICE_ID||"",advocate_monthly:process.env.STRIPE_ADVOCATE_MONTHLY_PRICE_ID||"",advocate_yearly:process.env.STRIPE_ADVOCATE_YEARLY_PRICE_ID||"",guardian_monthly:process.env.STRIPE_GUARDIAN_MONTHLY_PRICE_ID||"",guardian_yearly:process.env.STRIPE_GUARDIAN_YEARLY_PRICE_ID||"",hero_monthly:process.env.STRIPE_HERO_MONTHLY_PRICE_ID||"",hero_yearly:process.env.STRIPE_HERO_YEARLY_PRICE_ID||""}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,972,691,830,59],()=>s(82284));module.exports=t})();