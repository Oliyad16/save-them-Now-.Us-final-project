"use strict";(()=>{var e={};e.id=429,e.ids=[429],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},21764:e=>{e.exports=require("util")},63434:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>A,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>R,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{POST:()=>l});var o=r(49303),n=r(88716),i=r(60670),a=r(87070),c=r(71615),u=r(69234),d=r(42729);async function l(e){let t;let r=await e.text(),s=(0,c.headers)().get("stripe-signature");if(!s)return a.NextResponse.json({error:"No signature provided"},{status:400});if(!u.A)return a.NextResponse.json({error:"Stripe not configured"},{status:503});try{t=u.A.webhooks.constructEvent(r,s,u.K.webhookSecret)}catch(e){return console.error("Webhook signature verification failed:",e),a.NextResponse.json({error:"Invalid signature"},{status:400})}let o=(0,d.N)();try{switch(t.type){case"checkout.session.completed":{let e=t.data.object;"subscription"===e.mode?await p(e,o):await b(e,o);break}case"customer.subscription.created":case"customer.subscription.updated":{let e=t.data.object;await f(e,o);break}case"customer.subscription.deleted":{let e=t.data.object;await _(e,o);break}case"invoice.payment_succeeded":{let e=t.data.object;await y(e,o);break}case"invoice.payment_failed":{let e=t.data.object;await E(e,o);break}default:console.log(`Unhandled event type: ${t.type}`)}return a.NextResponse.json({received:!0})}catch(e){return console.error("Error processing webhook:",e),a.NextResponse.json({error:"Webhook processing failed"},{status:500})}}async function p(e,t){let r=e.metadata?.userId,s=e.customer,o=e.subscription;if(!r||!o){console.error("Missing userId or subscriptionId in checkout session");return}if(!u.A){console.error("Stripe not configured");return}let n=await u.A.subscriptions.retrieve(o),i=n.items.data[0]?.price.id,a=t.prepare("SELECT id FROM subscription_tiers WHERE stripe_price_id_monthly = ? OR stripe_price_id_yearly = ?").get(i,i);if(!a){console.error("Unknown price ID:",i);return}t.prepare(`
    INSERT OR REPLACE INTO subscriptions (
      user_id, tier_id, stripe_subscription_id, stripe_customer_id,
      status, current_period_start, current_period_end
    ) VALUES (?, ?, ?, ?, ?, ?, ?)
  `).run(r,a.id,o,s,n.status,new Date(1e3*n.current_period_start).toISOString(),new Date(1e3*n.current_period_end).toISOString()),t.prepare("UPDATE users SET tier = (SELECT name FROM subscription_tiers WHERE id = ?) WHERE id = ?").run(a.id,r),console.log(`Subscription created for user ${r}`)}async function f(e,t){let r=e.id;t.prepare(`
    UPDATE subscriptions 
    SET status = ?, 
        current_period_start = ?, 
        current_period_end = ?,
        cancel_at_period_end = ?
    WHERE stripe_subscription_id = ?
  `).run(e.status,new Date(1e3*e.current_period_start).toISOString(),new Date(1e3*e.current_period_end).toISOString(),e.cancel_at_period_end?1:0,r),console.log(`Subscription ${r} updated`)}async function _(e,t){let r=e.id;t.prepare(`
    UPDATE subscriptions 
    SET status = 'canceled'
    WHERE stripe_subscription_id = ?
  `).run(r);let s=t.prepare("SELECT user_id FROM subscriptions WHERE stripe_subscription_id = ?").get(r);s&&(t.prepare("UPDATE users SET tier = ? WHERE id = ?").run("free",s.user_id),console.log(`User ${s.user_id} downgraded to free tier`))}async function y(e,t){let r=e.subscription;e.customer;let s=t.prepare("SELECT user_id FROM subscriptions WHERE stripe_subscription_id = ?").get(r);s&&t.prepare(`
      INSERT INTO payments (
        user_id, stripe_payment_intent_id, amount, type, status, description
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).run(s.user_id,e.payment_intent,e.amount_paid/100,"subscription","completed",`Subscription payment for period ${new Date(1e3*e.period_start).toISOString().split("T")[0]} to ${new Date(1e3*e.period_end).toISOString().split("T")[0]}`),console.log(`Payment succeeded for invoice ${e.id}`)}async function E(e,t){let r=e.subscription,s=t.prepare("SELECT user_id FROM subscriptions WHERE stripe_subscription_id = ?").get(r);s&&(t.prepare(`
      INSERT INTO payments (
        user_id, stripe_payment_intent_id, amount, type, status, description
      ) VALUES (?, ?, ?, ?, ?, ?)
    `).run(s.user_id,e.payment_intent,e.amount_due/100,"subscription","failed",`Failed subscription payment for period ${new Date(1e3*e.period_start).toISOString().split("T")[0]} to ${new Date(1e3*e.period_end).toISOString().split("T")[0]}`),t.prepare(`
      INSERT INTO user_activity (user_id, activity_type, activity_data) 
      VALUES (?, 'payment_failed', '{"invoice_id": "' + ? + '"}')
    `).run(s.user_id,e.id)),console.log(`Payment failed for invoice ${e.id}`)}async function b(e,t){let r=e.metadata?.userId,s=e.amount_total/100;r&&(t.prepare(`
      INSERT INTO donations (
        user_id, amount, stripe_payment_intent_id, donation_type, anonymous
      ) VALUES (?, ?, ?, ?, ?)
    `).run(r,s,e.payment_intent,e.metadata?.donation_type||"general",e.metadata?.anonymous==="true"?1:0),console.log(`Donation of $${s} recorded for user ${r}`))}let g=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/stripe/webhooks/route",pathname:"/api/stripe/webhooks",filename:"route",bundlePath:"app/api/stripe/webhooks/route"},resolvedPagePath:"E:\\Download\\savethemnow.Jesus\\src\\app\\api\\stripe\\webhooks\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:R}=g,S="/api/stripe/webhooks/route";function A(){return(0,i.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:m})}},71615:(e,t,r)=>{r.r(t);var s=r(88757),o={};for(let e in s)"default"!==e&&(o[e]=()=>s[e]);r.d(t,o)},33085:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"DraftMode",{enumerable:!0,get:function(){return n}});let s=r(45869),o=r(6278);class n{get isEnabled(){return this._provider.isEnabled}enable(){let e=s.staticGenerationAsyncStorage.getStore();return e&&(0,o.trackDynamicDataAccessed)(e,"draftMode().enable()"),this._provider.enable()}disable(){let e=s.staticGenerationAsyncStorage.getStore();return e&&(0,o.trackDynamicDataAccessed)(e,"draftMode().disable()"),this._provider.disable()}constructor(e){this._provider=e}}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},88757:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{cookies:function(){return p},draftMode:function(){return f},headers:function(){return l}});let s=r(68996),o=r(53047),n=r(92044),i=r(72934),a=r(33085),c=r(6278),u=r(45869),d=r(54580);function l(){let e="headers",t=u.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return o.HeadersAdapter.seal(new Headers({}));(0,c.trackDynamicDataAccessed)(t,e)}return(0,d.getExpectedRequestStore)(e).headers}function p(){let e="cookies",t=u.staticGenerationAsyncStorage.getStore();if(t){if(t.forceStatic)return s.RequestCookiesAdapter.seal(new n.RequestCookies(new Headers({})));(0,c.trackDynamicDataAccessed)(t,e)}let r=(0,d.getExpectedRequestStore)(e),o=i.actionAsyncStorage.getStore();return(null==o?void 0:o.isAction)||(null==o?void 0:o.isAppRoute)?r.mutableCookies:r.cookies}function f(){let e=(0,d.getExpectedRequestStore)("draftMode");return new a.DraftMode(e.draftMode)}("function"==typeof t.default||"object"==typeof t.default&&null!==t.default)&&void 0===t.default.__esModule&&(Object.defineProperty(t.default,"__esModule",{value:!0}),Object.assign(t.default,t),e.exports=t.default)},53047:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{HeadersAdapter:function(){return n},ReadonlyHeadersError:function(){return o}});let s=r(38238);class o extends Error{constructor(){super("Headers cannot be modified. Read more: https://nextjs.org/docs/app/api-reference/functions/headers")}static callable(){throw new o}}class n extends Headers{constructor(e){super(),this.headers=new Proxy(e,{get(t,r,o){if("symbol"==typeof r)return s.ReflectAdapter.get(t,r,o);let n=r.toLowerCase(),i=Object.keys(e).find(e=>e.toLowerCase()===n);if(void 0!==i)return s.ReflectAdapter.get(t,i,o)},set(t,r,o,n){if("symbol"==typeof r)return s.ReflectAdapter.set(t,r,o,n);let i=r.toLowerCase(),a=Object.keys(e).find(e=>e.toLowerCase()===i);return s.ReflectAdapter.set(t,a??r,o,n)},has(t,r){if("symbol"==typeof r)return s.ReflectAdapter.has(t,r);let o=r.toLowerCase(),n=Object.keys(e).find(e=>e.toLowerCase()===o);return void 0!==n&&s.ReflectAdapter.has(t,n)},deleteProperty(t,r){if("symbol"==typeof r)return s.ReflectAdapter.deleteProperty(t,r);let o=r.toLowerCase(),n=Object.keys(e).find(e=>e.toLowerCase()===o);return void 0===n||s.ReflectAdapter.deleteProperty(t,n)}})}static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"append":case"delete":case"set":return o.callable;default:return s.ReflectAdapter.get(e,t,r)}}})}merge(e){return Array.isArray(e)?e.join(", "):e}static from(e){return e instanceof Headers?e:new n(e)}append(e,t){let r=this.headers[e];"string"==typeof r?this.headers[e]=[r,t]:Array.isArray(r)?r.push(t):this.headers[e]=t}delete(e){delete this.headers[e]}get(e){let t=this.headers[e];return void 0!==t?this.merge(t):null}has(e){return void 0!==this.headers[e]}set(e,t){this.headers[e]=t}forEach(e,t){for(let[r,s]of this.entries())e.call(t,s,r,this)}*entries(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase(),r=this.get(t);yield[t,r]}}*keys(){for(let e of Object.keys(this.headers)){let t=e.toLowerCase();yield t}}*values(){for(let e of Object.keys(this.headers)){let t=this.get(e);yield t}}[Symbol.iterator](){return this.entries()}}},68996:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(t,{MutableRequestCookiesAdapter:function(){return l},ReadonlyRequestCookiesError:function(){return i},RequestCookiesAdapter:function(){return a},appendMutableCookies:function(){return d},getModifiedCookieValues:function(){return u}});let s=r(92044),o=r(38238),n=r(45869);class i extends Error{constructor(){super("Cookies can only be modified in a Server Action or Route Handler. Read more: https://nextjs.org/docs/app/api-reference/functions/cookies#cookiessetname-value-options")}static callable(){throw new i}}class a{static seal(e){return new Proxy(e,{get(e,t,r){switch(t){case"clear":case"delete":case"set":return i.callable;default:return o.ReflectAdapter.get(e,t,r)}}})}}let c=Symbol.for("next.mutated.cookies");function u(e){let t=e[c];return t&&Array.isArray(t)&&0!==t.length?t:[]}function d(e,t){let r=u(t);if(0===r.length)return!1;let o=new s.ResponseCookies(e),n=o.getAll();for(let e of r)o.set(e);for(let e of n)o.set(e);return!0}class l{static wrap(e,t){let r=new s.ResponseCookies(new Headers);for(let t of e.getAll())r.set(t);let i=[],a=new Set,u=()=>{let e=n.staticGenerationAsyncStorage.getStore();if(e&&(e.pathWasRevalidated=!0),i=r.getAll().filter(e=>a.has(e.name)),t){let e=[];for(let t of i){let r=new s.ResponseCookies(new Headers);r.set(t),e.push(r.toString())}t(e)}};return new Proxy(r,{get(e,t,r){switch(t){case c:return i;case"delete":return function(...t){a.add("string"==typeof t[0]?t[0]:t[0].name);try{e.delete(...t)}finally{u()}};case"set":return function(...t){a.add("string"==typeof t[0]?t[0]:t[0].name);try{return e.set(...t)}finally{u()}};default:return o.ReflectAdapter.get(e,t,r)}}})}}},42729:(e,t,r)=>{r.d(t,{N:()=>p});let s=require("better-sqlite3");var o=r.n(s),n=r(92048),i=r.n(n),a=r(55315),c=r.n(a);let u=process.env.DATABASE_PATH||c().join(process.cwd(),"database.sqlite"),d=c().join(process.cwd(),"src/lib/database/schema.sql"),l=null;function p(){if(!l){let e=c().dirname(u);i().existsSync(e)||i().mkdirSync(e,{recursive:!0}),(l=new(o())(u)).pragma("journal_mode = WAL"),l.pragma("foreign_keys = ON"),l&&(l.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='users'").get()||(console.log("Initializing database schema..."),i().existsSync(d)?(i().readFileSync(d,"utf8").split(";").filter(e=>e.trim()).forEach(e=>{try{l.exec(e)}catch(e){console.error("Error executing schema statement:",e)}}),console.log("Database schema initialized successfully")):console.error("Schema file not found at:",d)))}return l}function f(){l&&(l.close(),l=null)}process.on("SIGINT",f),process.on("SIGTERM",f)},69234:(e,t,r)=>{r.d(t,{A:()=>o,K:()=>n});var s=r(31059);let o=process.env.STRIPE_SECRET_KEY?new s.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2024-11-20.acacia",typescript:!0}):null,n={publishableKey:process.env.STRIPE_PUBLISHABLE_KEY||"",webhookSecret:process.env.STRIPE_WEBHOOK_SECRET||"",currency:"usd",prices:{supporter_monthly:process.env.STRIPE_SUPPORTER_MONTHLY_PRICE_ID||"",supporter_yearly:process.env.STRIPE_SUPPORTER_YEARLY_PRICE_ID||"",advocate_monthly:process.env.STRIPE_ADVOCATE_MONTHLY_PRICE_ID||"",advocate_yearly:process.env.STRIPE_ADVOCATE_YEARLY_PRICE_ID||"",guardian_monthly:process.env.STRIPE_GUARDIAN_MONTHLY_PRICE_ID||"",guardian_yearly:process.env.STRIPE_GUARDIAN_YEARLY_PRICE_ID||"",hero_monthly:process.env.STRIPE_HERO_MONTHLY_PRICE_ID||"",hero_yearly:process.env.STRIPE_HERO_YEARLY_PRICE_ID||""}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,59],()=>r(63434));module.exports=s})();